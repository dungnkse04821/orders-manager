@page
@model OrdersManager.Pages.Orders.IncomingModel
@{
    ViewData["Title"] = "Xử lý hàng loạt";
    var statusList = OrdersManager.Models.OrderStatusList.All;
}

<style>
    body {
        padding-bottom: 80px;
    }
</style>

<form method="post" id="mainForm">
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow-sm h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-white-50">Số lượng đơn</h6>
                        <h3 class="fw-bold mb-0">@Model.TotalCount</h3>
                    </div>
                    <i class="bi bi-box-seam fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark shadow-sm h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-dark-50">Tổng vốn nhập (Ước tính)</h6>
                        <h3 class="fw-bold mb-0">@Model.TotalImportCapital.ToString("N0") <small class="fs-6">đ</small></h3>
                    </div>
                    <i class="bi bi-cash-stack fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white shadow-sm h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-white-50">Tổng doanh thu bán</h6>
                        <h3 class="fw-bold mb-0">@Model.TotalRevenue.ToString("N0") <small class="fs-6">đ</small></h3>
                    </div>
                    <i class="bi bi-graph-up-arrow fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3 shadow-sm border-primary">
        <div class="card-body py-3">
            <div class="row g-2 mb-3">
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-muted">Trạng thái</label>
                    <select name="StatusFilter" class="form-select form-select-sm">@*  onchange="this.form.method='get'; this.form.submit()" *@
                        <option value="ALL">-- Tất cả --</option>
                        @foreach (var s in statusList)
                        {
                            <!option value="@s" @(Model.StatusFilter == s ? "selected" : "")>@s</!option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-muted">Nguồn hàng</label>
                    <select name="SourceFilter" class="form-select form-select-sm">
                        <option value="">-- Tất cả --</option>
                        @foreach (var s in Model.Sources)
                        {
                            <!option value="@s" @(Model.SourceFilter == s ? "selected" : "")>@s</!option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-muted">Kho hàng</label>
                    <select name="WarehouseFilter" class="form-select form-select-sm">
                        <option value="">-- Tất cả --</option>
                        @foreach (var w in Model.Warehouses)
                        {
                            <!option value="@w" @(Model.WarehouseFilter == w ? "selected" : "")>@w</!option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">Từ ngày</label>
                    <input type="date" name="FromDate" value="@Model.FromDate" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">Đến ngày</label>
                    <input type="date" name="ToDate" value="@Model.ToDate" class="form-control form-control-sm" />
                </div>
                
            </div>
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label class="form-label fw-bold small">Tìm Khách/SĐT/Code:</label>
                    <div class="input-group">
                        <input asp-for="SearchTerm" class="form-control" placeholder="Nhập tên, SĐT hoặc mã đơn..." />
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" formmethod="get" class="btn btn-primary w-100 fw-bold me-2">
                        <i class="bi bi-funnel"></i> Lọc
                    </button>
                    <a asp-page="./Incoming" class="btn btn-outline-secondary" title="Xóa lọc">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </a>
                </div>
                <div class="col-md-1 text-center d-none d-md-block">
                    <i class="bi bi-arrow-right fs-3 text-muted"></i>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-success">Chuyển sang trạng thái:</label>
                    <select asp-for="TargetStatus" class="form-select fw-bold border-success text-success" id="ddlTargetStatus">
                        <option value="">-- Chọn trạng thái --</option>
                        @foreach (var s in statusList)
                        {
                            <option value="@s">@s</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive bg-white shadow-sm rounded">
        <table class="table table-hover align-middle table-sm" id="orderTable">
            <thead class="table-light">
                <tr>
                    <th class="text-center" style="width: 40px;">
                        <input type="checkbox" id="selectAll" class="form-check-input" style="cursor:pointer" />
                    </th>
                    <th>Ngày đặt</th>
                    <th>Mã Code</th>
                    <th>Kho/Nguồn</th>
                    <th style="width: 100px;">Trạng thái</th>
                    <th>Khách hàng</th>
                    <th>Sản phẩm</th>

                    <th class="col-arrival bg-warning bg-opacity-10" style="display:none; width: 120px;">Giá Vốn</th>
                    <th class="col-arrival bg-warning bg-opacity-10" style="display:none; width: 140px;">Ngày Về</th>

                    <th class="col-delivery bg-success bg-opacity-10" style="display:none; width: 140px;">Đã thu (k)</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items.Count == 0)
                {
                    <tr><td colspan="9" class="text-center py-5 text-muted">Không tìm thấy đơn hàng nào phù hợp.</td></tr>
                }
                else
                {
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        var item = Model.Items[i];
                        <input type="hidden" asp-for="Items[i].Id" />
                        <input type="hidden" asp-for="Items[i].Code" />

                        <tr class="@(item.IsSelected ? "table-active" : "")">
                            <td class="text-center">
                                <input asp-for="Items[i].IsSelected"
                                       class="form-check-input item-check"
                                       style="cursor:pointer"
                                       data-code="@item.Code"
                                       data-product="@item.ProductName"
                                       data-quantity="@item.Quantity"
                                       data-price="@item.SellingPrice"
                                       data-customer="@item.CustomerName"
                                       data-money="@item.RemainingAmount" />
                            </td>
                            <td class="small text-muted">@(item.OrderDate?.ToString("dd/MM/yyyy"))</td>
                            <td class="fw-bold text-primary small">#@item.Code</td>
                            <td>
                                <span class="badge bg-light text-dark border">@item.Source</span>
                                <span class="badge bg-light text-dark border">@item.Warehouse</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary text-wrap" style="font-size: 0.7rem;">@item.Status</span>
                            </td>
                            <td>
                                <div class="fw-bold small">@item.CustomerName</div>
                                <div class="small text-muted" style="font-size: 0.75rem;">@item.PhoneNumber</div>
                            </td>
                            <td class="small">
                                @item.ProductName <span class="text-muted">x @item.Quantity</span>
                                @if (item.RemainingAmount > 0)
                                {
                                    <div class="text-danger fw-bold" style="font-size: 0.75rem;">
                                        Phải thu: @item.RemainingAmount.ToString("N0")
                                    </div>
                                }
                                else
                                {
                                    <div class="text-success fw-bold" style="font-size: 0.75rem;">
                                        <i class="bi bi-check-all"></i> Đã thanh toán đủ
                                    </div>
                                }
                            </td>

                            <td class="col-arrival bg-warning bg-opacity-10" style="display:none">
                                <input asp-for="Items[i].ImportPrice" class="form-control form-control-sm text-end" type="number" placeholder="0" />
                            </td>
                            <td class="col-arrival bg-warning bg-opacity-10" style="display:none">
                                <input asp-for="Items[i].ArrivalDate" class="form-control form-control-sm" type="date" asp-format="{0:yyyy-MM-dd}" />
                            </td>

                            <td class="col-delivery bg-success bg-opacity-10" style="display:none">
                                <input asp-for="Items[i].PaidAmount" class="form-control form-control-sm text-end fw-bold text-success" type="number" />
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="fixed-bottom bg-white border-top shadow p-3" style="z-index: 1000;">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center gap-3">
                        <span class="fs-5">Đã chọn: <strong id="lblCount" class="text-primary">0</strong></span>
                        <span class="fs-4 border-start ps-3">Tổng thu: <strong id="lblTotal" class="text-danger">0</strong> đ</span>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button type="button" class="btn btn-outline-primary me-2" onclick="openQrModal()">
                        <i class="bi bi-qr-code-scan"></i> QR Chuyển khoản
                    </button>
                    <button type="submit" class="btn btn-success fw-bold px-4" onclick="return confirm('Bạn có chắc chắn muốn cập nhật các đơn hàng đã chọn?')">
                        <i class="bi bi-check2-all"></i> Cập nhật ngay
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> Xác nhận thanh toán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0">
                    <div class="col-md-7 p-4 border-end bg-light">
                        <h6 class="fw-bold text-muted mb-3 text-uppercase">Danh sách đơn hàng</h6>

                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-borderless">
                                <thead class="border-bottom text-muted small">
                                    <tr>
                                        <th>Mã đơn/SP</th>
                                        <th>Đ.Giá</th>
                                        <th>SL</th>
                                        <th class="text-end">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody id="billBody">
                                </tbody>
                                <tfoot class="border-top fw-bold">
                                    <tr>
                                        <td colspan="3" class="pt-3">TỔNG CỘNG</td>
                                        <td class="text-end pt-3 text-danger fs-5" id="billTotalDisplay">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="col-md-5 p-4 text-center d-flex flex-column justify-content-center align-items-center bg-white">
                        <h6 class="fw-bold text-muted mb-3">QUÉT MÃ VIETQR</h6>

                        <div id="qrContainer" class="mb-3 border p-2 rounded shadow-sm">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>

                        <div class="w-100 bg-light p-2 rounded border text-start">
                            <div class="small text-muted">Chủ tài khoản:</div>
                            <div class="fw-bold text-primary">@Model.AccountName</div>
                            <div class="small text-muted mt-1">Nội dung CK:</div>
                            <div class="fw-bold text-dark font-monospace text-break" id="qrContentDisplay">...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success fw-bold" onclick="submitQrPayment()">
                    <i class="bi bi-check2-circle"></i> Đã nhận tiền & Cập nhật
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const BANK_ID = "@Model.BankId";
        const ACCOUNT_NO = "@Model.AccountNo";
        const ACCOUNT_NAME = "@Model.AccountName";
        const TEMPLATE = "print";

        $(document).ready(function() {

            // --- A. TÍNH TOÁN TỔNG TIỀN (Giữ nguyên) ---
            function updateTotals() {
                var count = 0;
                var total = 0;

                $('.item-check:checked').each(function() {
                    count++;
                    // Lấy số tiền từ data-money (đã trừ cọc)
                    var money = parseFloat($(this).data('money')) || 0;
                    total += money;
                });

                $('#lblCount').text(count);
                $('#lblTotal').text(total.toLocaleString('vi-VN'));
                return { count, total };
            }

            // Sự kiện Check All
            $('#selectAll').click(function () {
                $('.item-check').prop('checked', this.checked).trigger('change');
            });

            // Sự kiện Check từng dòng
            $('.item-check').change(function() {
                var row = $(this).closest('tr');
                if(this.checked) row.addClass('table-active');
                else row.removeClass('table-active');

                updateTotals();
            });

            // --- B. ẨN HIỆN CỘT THEO TRẠNG THÁI (Giữ nguyên) ---
            function toggleColumns() {
                var target = $('#ddlTargetStatus').val();

                // 1. Ẩn hết trước
                $('.col-arrival, .col-delivery').hide();
                $('.col-arrival input, .col-delivery input').prop('disabled', true);

                // 2. Hiện theo logic
                if (target === "Đã về") {
                    $('.col-arrival').show();
                    $('.col-arrival input').prop('disabled', false);
                }
                else if (target === "Đã giao") {
                    $('.col-delivery').show();
                    $('.col-delivery input').prop('disabled', false);
                }
            }

            $('#ddlTargetStatus').change(toggleColumns);
            toggleColumns();
        });

        // --- C. HÀM TẠO QR CODE & HÓA ĐƠN (NÂNG CẤP) ---
        function openQrModal() {
            var selectedBoxes = $('.item-check:checked');
            if (selectedBoxes.length === 0) {
                alert("Bạn chưa chọn đơn hàng nào!");
                return;
            }

            var totalAmount = 0;
            var codes = [];
            var billHtml = "";

            // --- BIẾN KIỂM TRA KHÁCH HÀNG ---
            var firstCustomer = null;
            var isSameCustomer = true;

            // Duyệt qua từng dòng đã chọn
            selectedBoxes.each(function() {
                var $el = $(this);

                var money = parseFloat($el.data('money')) || 0;
                var price = parseFloat($el.data('price')) || 0;
                var quantity = parseInt($el.data('quantity')) || 0;
                var code = $el.data('code');
                var product = $el.data('product');
                var customer = $el.data('customer');

                // 2. CHECK TRÙNG KHÁCH HÀNG
                if (firstCustomer === null) {
                    firstCustomer = customer; // Gán người đầu tiên làm chuẩn
                } else if (firstCustomer !== customer) {
                    isSameCustomer = false; // Phát hiện khác khách hàng
                    return false; // Break vòng lặp
                }

                totalAmount += money;
                codes.push(code);

                // 3. TẠO HTML (Thêm cột Đơn giá và Số lượng)
                billHtml += `
                    <tr>
                        <td>
                            <div class="fw-bold text-primary small">${code}</div>
                            <div class="small text-truncate text-muted" style="max-width: 150px;" title="${product}">${product}</div>
                        </td>
                        <td class="text-center small">${price.toLocaleString('vi-VN')}</td>
                        <td class="text-center fw-bold small">${quantity}</td>
                        <td class="text-end fw-bold">${money.toLocaleString('vi-VN')}</td>
                    </tr>
                `;
            });

            // --- XỬ LÝ LỖI ---
            if (!isSameCustomer) {
                alert("LỖI: Bạn đang chọn đơn hàng của NHIỀU KHÁCH KHÁC NHAU.\nVui lòng chỉ chọn đơn của cùng 1 khách để thanh toán.");
                return;
            }

            if (totalAmount <= 0) {
                alert("Tổng tiền bằng 0đ. Không cần thanh toán.");
                return;
            }

            // --- 1. HIỂN THỊ HÓA ĐƠN ---
            $('#billBody').html(billHtml);
            $('#billTotalDisplay').text(totalAmount.toLocaleString('vi-VN') + " đ");

            // --- 2. TẠO MÃ QR ---
            // Nội dung: "[Tên Khách] TT [Mã Đơn...]"
            var contentRaw = firstCustomer + " TT " + codes.join(" ");

            // Cắt ngắn nếu quá dài (VietQR giới hạn ~50 ký tự)
            var content = contentRaw.length > 50 ? contentRaw.substring(0, 47) + "..." : contentRaw;

            var encodedContent = encodeURIComponent(content);
            var encodedName = encodeURIComponent(ACCOUNT_NAME);

            // Link API VietQR
            var qrUrl = `https://img.vietqr.io/image/${BANK_ID}-${ACCOUNT_NO}-${TEMPLATE}.png?amount=${totalAmount}&addInfo=${encodedContent}&accountName=${encodedName}`;

            $('#qrContentDisplay').text(content);
            $('#qrContainer').html(`<img src="${qrUrl}" class="img-fluid border" style="max-height: 250px;" alt="QR Code" />`);

            // Hiện Modal
            new bootstrap.Modal(document.getElementById('qrModal')).show();
        }

        function submitQrPayment() {
            // 1. Lấy danh sách các checkbox đang chọn
            var selectedBoxes = $('.item-check:checked');

            if (selectedBoxes.length === 0) {
                alert("Chưa chọn đơn hàng nào!");
                return;
            }

            // 2. Duyệt qua từng dòng để điền tiền
            selectedBoxes.each(function() {
                var $checkbox = $(this);
                var row = $checkbox.closest('tr');

                // Lấy số tiền còn thiếu từ data-money
                var moneyToPay = parseFloat($checkbox.data('money')) || 0;

                // Tìm ô input "Thực thu" (nằm trong cột có class .col-delivery)
                // Và điền số tiền vào đó
                var $inputPaid = row.find('.col-delivery input');

                // Chỉ điền nếu số tiền > 0
                if(moneyToPay > 0) {
                    $inputPaid.val(moneyToPay);
                }

                // Đảm bảo ô input này không bị disabled (để submit được giá trị về server)
                $inputPaid.prop('disabled', false);
            });

            // 3. Đảm bảo dropdown hành động đang chọn đúng là "Đã giao"
            // (Để backend biết là cần update tiền)
            $('#ddlTargetStatus').val('Đã giao');

            // 4. Submit Form chính
            if(confirm('Hệ thống sẽ cập nhật trạng thái "Đã giao" và ghi nhận thanh toán cho các đơn đã chọn.\nBạn chắc chắn chứ?')) {
                $('#mainForm').submit();
            }
        }
    </script>
}